<div class="chat-app">
  <!-- Notification Banner - ENTFERNT: Redundant mit Permission Dialog -->

  <!-- Sidebar -->
  <div class="chat-sidebar" [class.hidden]="selectedChat" @slideInOut>
    <div class="sidebar-header">
      <div class="header-content">
        <h2>Live Support</h2>
        <div class="header-actions">
          <button mat-icon-button (click)="toggleStaffManagement()" *ngIf="isAdmin" matTooltip="Mitarbeiter verwalten">
            <mat-icon>people</mat-icon>
          </button>
          <button mat-icon-button (click)="goToProfile()" matTooltip="Profil bearbeiten">
            <mat-icon>person</mat-icon>
          </button>
          <mat-slide-toggle #darkModeSwitch (click)="toggleDarkMode()" [checked]="darkMode" class="darkmode-button"></mat-slide-toggle>
        </div>
      </div>

      <!-- Suchleiste -->
      <div class="search-bar">
        <mat-icon>search</mat-icon>
        <input placeholder="Chats durchsuchen..."
               [(ngModel)]="searchQuery"
               (input)="filterChats($event)">
      </div>

      <!-- Filter-Controls (nur für Admin-Ansicht) -->
      <div class="filter-controls" *ngIf="isAdmin && showAllChats">
        <!-- Channel Filter -->
        <mat-button-toggle-group [(ngModel)]="selectedChannelFilter" (change)="filterByChannel($event.value)">
          <mat-button-toggle value="all">
            <mat-icon>all_inbox</mat-icon>
            Alle
          </mat-button-toggle>
          <mat-button-toggle value="website">
            <mat-icon>public</mat-icon>
            Website
          </mat-button-toggle>
          <mat-button-toggle value="whatsapp">
            <mat-icon>chat</mat-icon>
            WhatsApp
          </mat-button-toggle>
        </mat-button-toggle-group>

        <mat-button-toggle-group [(ngModel)]="filterStatus" (change)="changeStatusFilter($event.value)">
          <mat-button-toggle value="all">Alle</mat-button-toggle>
          <mat-button-toggle value="human">Offen</mat-button-toggle>
          <mat-button-toggle value="in_progress">Aktiv</mat-button-toggle>
          <mat-button-toggle value="closed">Geschlossen</mat-button-toggle>
        </mat-button-toggle-group>

        <mat-button-toggle-group [(ngModel)]="filterTimeRange" (change)="changeTimeFilter($event.value)">
          <mat-button-toggle value="all">Alle Zeit</mat-button-toggle>
          <mat-button-toggle value="today">Heute</mat-button-toggle>
          <mat-button-toggle value="week">Diese Woche</mat-button-toggle>
          <mat-button-toggle value="month">Dieser Monat</mat-button-toggle>
        </mat-button-toggle-group>
      </div>
    </div>

    <div class="chat-list-container">
      <!-- Aktive Chats (standard Ansicht) -->
      <div class="chat-list-section" *ngIf="!showAllChats || !isAdmin">
        <div *ngFor="let chat of filteredActiveChats; trackBy: trackByChatId"
             class="chat-item"
             [class.active]="selectedChat?.id === chat.id"
             [class.unread]="chat.unreadCount > 0"
             [class.assigned-to-me]="chat.assigned_to === currentAgent.id"
             [class.assigned-to-other]="chat.assigned_to && chat.assigned_to !== currentAgent.id"
             [class.needs-assignment]="chat.status === 'human' && !chat.assigned_to"
             [class.is-new]="chat.isNew"
             (click)="selectChat(chat)">

          <div class="avatar-container">
            <img [src]="chat.customerAvatar || 'assets/default-avatar.png'" [class.online]="chat.isOnline">
            <span class="unread-badge" *ngIf="chat.unreadCount > 0">{{chat.unreadCount}}</span>

            <div class="escalation-indicator" *ngIf="chat.status === 'human' && !chat.assigned_to">
              <mat-icon>priority_high</mat-icon>
            </div>
          </div>

          <div class="chat-info">
            <div class="chat-name-row">
              <span class="chat-name">{{chat.customerName || 'Anonymer Benutzer'}}</span>
              <!-- WhatsApp Channel Badge -->
              <span class="channel-badge whatsapp" *ngIf="isWhatsAppChat(chat)" matTooltip="WhatsApp Chat">
                <mat-icon>chat</mat-icon>
              </span>
            </div>

            <div class="chat-preview">{{chat.lastMessage | truncate:25}}</div>

            <div class="chat-status-container">
              <div class="chat-status-badge" [class]="'status-' + chat.status">
                {{getStatusLabel(chat.status)}}
              </div>

              <!-- Assignment Info -->
              <div class="assignment-info" *ngIf="chat.assigned_agent">
                <mat-icon class="assignment-icon">person</mat-icon>
                <span class="agent-name">{{ chat.assigned_agent | truncate:12 }}</span>
              </div>

            </div>
          </div>

          <div class="chat-meta">
            <div class="chat-time">{{ chat.lastMessageTime | date:'dd.MM HH:mm' }}</div>

            <!-- Quick Action Buttons in der Chat-Liste -->
            <div class="quick-action" *ngIf="chat.status === 'human' && !chat.assigned_to">
              <button
                *ngIf="selectedChat && canAssignChat(selectedChat)"
                mat-raised-button
                color="primary"
                class="action-btn assign-btn"
                (click)="handleChatAssignment(selectedChat)"
                matTooltip="Chat übernehmen">
                <mat-icon>person_add</mat-icon>
                Übernehmen
              </button>
            </div>

            <!-- Assignment Indicator für zugewiesene Chats -->
            <div class="assignment-indicator" *ngIf="chat.assigned_to">
              <mat-icon
                [matTooltip]="getAssignmentInfo(chat)"
                [color]="chat.assigned_to === currentAgent.id ? 'primary' : 'accent'"
                class="assignment-status-icon">
                {{ chat.assigned_to === currentAgent.id ? 'person' : 'group' }}
              </mat-icon>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin-Chats (erweiterte Ansicht) -->
      <div class="chat-list-section" *ngIf="isAdmin && showAllChats">
        <div class="section-header">
          <span>Alle Chats</span>
          <mat-spinner *ngIf="loadingAdminChats" diameter="20" class="loading-spinner"></mat-spinner>
        </div>

        <div *ngIf="filteredAdminChats.length === 0 && !loadingAdminChats" class="no-chats">
          <mat-icon>chat_bubble_outline</mat-icon>
          <span>Keine Chats gefunden</span>
        </div>

        <div *ngFor="let chat of filteredAdminChats; trackBy: trackByAdminChatId"
             class="chat-item admin-chat"
             [class.active]="selectedChat?.id === chat.session_id"
             [class.assigned-to-me]="chat.assigned_to === currentAgent.id"
             [class.assigned-to-other]="chat.assigned_to && chat.assigned_to !== currentAgent.id"
             [class.needs-assignment]="chat.status === 'human' && !chat.assigned_to"
             (click)="selectAdminChat(chat)">

          <div class="avatar-container">
            <img [src]="chat.customer_avatar || 'assets/default-avatar.png'" [class.online]="chat.is_online">

            <!-- Escalation Indicator für Admin-Chats -->
            <div class="escalation-indicator" *ngIf="chat.status === 'human' && !chat.assigned_to">
              <mat-icon>priority_high</mat-icon>
            </div>
          </div>

          <div class="chat-info">
            <div class="chat-name-row">
              <span class="chat-name">
                {{(chat.customer_first_name && chat.customer_last_name) ?
                (chat.customer_first_name + ' ' + chat.customer_last_name) :
                (chat.customer_name || 'Anonymer Benutzer')}}
              </span>
              <!-- WhatsApp Channel Badge -->
              <span class="channel-badge whatsapp" *ngIf="chat.channel === 'whatsapp'" matTooltip="WhatsApp Chat">
                <mat-icon>chat</mat-icon>
              </span>
            </div>

            <div class="chat-preview">{{chat.last_message | truncate:25}}</div>

            <div class="chat-status-container">
              <div class="chat-status-badge" [class]="'status-' + chat.status">
                {{getStatusLabel(chat.status)}}
              </div>

              <div class="assignment-info" *ngIf="chat.assigned_agent">
                <mat-icon class="assignment-icon">person</mat-icon>
                <span class="agent-name">{{ chat.assigned_agent | truncate:12 }}</span>
              </div>
            </div>
          </div>

          <div class="chat-meta">
            <div class="chat-time">{{chat.last_message_time | date:'dd.MM HH:mm'}}</div>

            <!-- Quick Action für Admin-Chats -->
            <div class="quick-action" *ngIf="chat.status === 'human' && !chat.assigned_to">
              <button mat-mini-fab
                      color="primary"
                      (click)="assignAdminChat(chat); $event.stopPropagation()"
                      matTooltip="Sofort übernehmen"
                      class="quick-assign-btn">
                <mat-icon>person_add</mat-icon>
              </button>
            </div>

            <!-- Assignment Indicator -->
            <div class="assignment-indicator" *ngIf="chat.assigned_to">
              <mat-icon
                [matTooltip]="chat.assigned_agent ? 'Zugewiesen an ' + chat.assigned_agent : 'Zugewiesen'"
                [color]="chat.assigned_to === currentAgent.id ? 'primary' : 'accent'"
                class="assignment-status-icon">
                {{ chat.assigned_to === currentAgent.id ? 'person' : 'group' }}
              </mat-icon>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- User Profile Footer -->
    <div class="user-profile">
      <img [src]="getFullProfileImageUrl(currentAgent.profile_image_url) || currentAgent.avatar || 'assets/default-avatar.png'" class="profile-avatar">
      <div class="profile-info">
        <div class="profile-name">{{currentAgent.name}}</div>
        <div class="profile-status">
          <mat-icon class="status-dot">fiber_manual_record</mat-icon>
          Online
        </div>
      </div>
      <div class="profile-actions">
        @if (isAdmin) {
          <button mat-icon-button class="profile-action-btn" matTooltip="Angebote verwalten"
                  (click)="toggleOfferManagement()">
            <mat-icon>local_offer</mat-icon>
          </button>
          <button mat-icon-button class="profile-action-btn" matTooltip="Buchungsliste"
                  routerLink="/admin/buchungsliste">
            <mat-icon>list_alt</mat-icon>
          </button>
          <button mat-icon-button class="profile-action-btn" matTooltip="Chatbot trainieren"
                  routerLink="/admin/chatbot-trainieren">
            <mat-icon>smart_toy</mat-icon>
          </button>
          <button mat-icon-button class="profile-action-btn" matTooltip="Alle Nachrichten"
                  (click)="toggleAllChatsView()" [class.active]="showAllChats">
            <mat-icon>forum</mat-icon>
          </button>
        }
        <button mat-icon-button class="profile-action-btn" matTooltip="Zur Startseite"
                routerLink="/">
          <mat-icon>home</mat-icon>
        </button>
        <button mat-icon-button class="profile-action-btn" matTooltip="Ausloggen"
                (click)="logout()">
          <mat-icon>logout</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Chat Area -->
  <div class="chat-main" *ngIf="selectedChat; else noChatSelected">
    <div class="chat-header">
      <!-- Zurück -->
      <button mat-icon-button class="back-btn" (click)="selectedChat = null">
        <mat-icon>arrow_back</mat-icon>
      </button>

      <div class="chat-user">
        <div class="avatar-container">
          <img [src]="selectedChat.customerAvatar || 'assets/default-avatar.png'"
               [class.online]="selectedChat.isOnline"
               class="user-avatar">
        </div>

        <div class="user-info">
          <div class="user-header">
            <h3 class="user-name">
              {{(visitor?.first_name && visitor?.last_name) ?
              (visitor.first_name + ' ' + visitor.last_name) :
              (selectedChat.customerName || 'Anonymer Benutzer')}}
              <!-- WhatsApp Channel Badge in Header -->
              <span class="channel-badge whatsapp header-badge" *ngIf="isWhatsAppChat(selectedChat)" matTooltip="WhatsApp Chat">
                <mat-icon>chat</mat-icon>
                WhatsApp
              </span>
            </h3>
            <div class="status-container">
              <div *ngIf="selectedChat.isOnline" class="user-status online">
                <mat-icon class="status-icon">circle</mat-icon>
                <span>Online</span>
              </div>
              <div *ngIf="!selectedChat.isOnline" class="user-status offline">
                <mat-icon class="status-icon">circle</mat-icon>
                <span>Zuletzt online {{selectedChat.lastOnline | date:'shortTime'}}</span>
              </div>
            </div>
          </div>

          <!-- ✅ Visitor Details mit korrekter Telefonnummer-Anzeige -->
          <div class="visitor-details">
            @if (isAdmin) {
              <!-- ✅ Für WhatsApp-Chats: Zeige WhatsApp-Nummer -->
              <div class="detail-item" *ngIf="isWhatsAppChat(selectedChat) && selectedChat.whatsapp_number">
                <mat-icon class="detail-icon">chat</mat-icon>
                <a href="https://wa.me/{{selectedChat.whatsapp_number}}" target="_blank" class="whatsapp-link">
                  {{formatWhatsAppNumber(selectedChat.whatsapp_number)}}
                </a>
              </div>

              <!-- ✅ Für Website-Chats: Zeige normale Telefonnummer (nur wenn visitor existiert) -->
              <div class="detail-item" *ngIf="!isWhatsAppChat(selectedChat) && visitor?.phone">
                <mat-icon class="detail-icon">phone</mat-icon>
                <a href="tel:{{visitor.phone}}" class="phone-link">{{visitor.phone}}</a>
              </div>

              <!-- ✅ Email nur für Admin anzeigen, wenn visitor existiert -->
              <div class="detail-item" *ngIf="visitor?.email">
                <mat-icon class="detail-icon">email</mat-icon>
                <a href="mailto:{{visitor.email}}" class="email-link">{{visitor.email}}</a>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Assignment Status Indicator -->
      <div class="assignment-status" *ngIf="selectedChat">
        <div class="status-badge" [ngClass]="getAssignmentStatusClass(selectedChat)">
          {{ getAssignmentInfo(selectedChat) }}
        </div>
      </div>

      <!-- Header Actions -->
      <div class="header-actions">
        <!-- Assignment Button -->
        <button
          *ngIf="selectedChat && selectedChat.status === 'human' && !selectedChat.assigned_to"
          mat-raised-button
          color="primary"
          class="action-btn assign-btn"
          (click)="handleChatAssignment(selectedChat)"
          matTooltip="Chat übernehmen">
          <mat-icon>person_add</mat-icon>
          Übernehmen
        </button>

        <!-- Transfer Button -->
        <button
          *ngIf="canTransferChat(selectedChat)"
          mat-stroked-button
          class="action-btn"
          (click)="openTransferDialog(selectedChat)"
          matTooltip="Chat übertragen">
          <mat-icon>swap_horiz</mat-icon>
          Übertragen
        </button>

        <!-- Unassign Button (nur Admin) -->
        <button
          *ngIf="isAdmin && selectedChat?.assigned_to"
          mat-stroked-button
          color="warn"
          class="action-btn"
          (click)="unassignChat(selectedChat)"
          matTooltip="Zuweisung aufheben">
          <mat-icon>person_remove</mat-icon>
          Aufheben
        </button>


        <!-- Transfer History Button -->
        <button
          *ngIf="selectedChat?.assigned_to && isAdmin"
          mat-icon-button
          class="icon-btn"
          (click)="showTransferHistory(selectedChat)"
          matTooltip="Transfer History anzeigen">
          <mat-icon>history</mat-icon>
        </button>

        <!-- Close Chat Button -->
        <button
          mat-icon-button
          class="icon-btn"
          matTooltip="Chat beenden"
          (click)="openCloseChatDialog(selectedChat)"
          *ngIf="selectedChat && selectedChat.status !== 'closed'">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>

    <!-- Echtzeit-Status-Updates Anzeige

    <div class="real-time-updates" *ngIf="selectedChat?.isNew">
      <div class="update-notification">
        <mat-icon>notification_important</mat-icon>
        <span>Status aktualisiert - Neue Aktionen verfügbar</span>
      </div>
    </div>
-->
    <!-- Nachrichtenbereich -->
    <div class="message-area"
         #messagesContainer
         (scroll)="onScroll($event)"
         [class.loading]="isLoadingChat">
      <div *ngFor="let message of selectedChat.messages; trackBy: trackByMessageId"
           class="message"
           [class.agent]="message.isAgent"
           [class.customer]="!message.isAgent && !message.isBot"
           [class.bot]="message.isBot"
           [class.system]="message.from === 'system'"
           [class.escalation]="message.message_type === 'escalation_prompt'"
           @messageAnimation>
        <div class="message-content">
          <!-- System Message Icon (nur Icon, kein Text) -->
          <mat-icon class="system-message-icon-inline" *ngIf="message.from === 'system'">info</mat-icon>

          <!-- Escalation Badge -->
          <div class="escalation-badge" *ngIf="message.message_type === 'escalation_prompt'">
            <mat-icon>support_agent</mat-icon>
            <span>Eskalationsanfrage gesendet</span>
          </div>

          <div class="message-text">{{message.content | messageFilter: isAdmin}}</div>

          <!-- File Attachment Display -->
          <div class="message-attachment" *ngIf="message.attachment">
            <!-- Image Preview -->
            <div *ngIf="message.attachment.file_type === 'image'" class="image-preview" (click)="downloadFile(message.attachment)">
              <img [src]="message.attachment.download_url" [alt]="message.attachment.file_name" />
              <div class="image-overlay">
                <mat-icon>download</mat-icon>
              </div>
            </div>

            <!-- Audio/Voice Player -->
            <div *ngIf="message.attachment.file_type === 'audio' || message.attachment.file_type === 'voice'" class="audio-player-card">
              <button mat-icon-button class="play-button" (click)="toggleAudioPlay(message.attachment)">
                <mat-icon>{{isAudioPlaying(message.attachment) ? 'pause' : 'play_arrow'}}</mat-icon>
              </button>
              <div class="audio-info">
                <div class="audio-waveform"
                     (click)="seekAudio(message.attachment, $event)"
                     [style.cursor]="'pointer'"
                     matTooltip="Klicken um zu springen">
                  <div class="waveform-bars">
                    <span class="bar" *ngFor="let bar of [1,2,3,4,5,6,7,8,9,10,11,12]"></span>
                  </div>
                  <div class="audio-progress" [style.width.%]="getAudioProgress(message.attachment)"></div>
                </div>
                <div class="audio-duration">{{getAudioCurrentTime(message.attachment)}} / {{getAudioDuration(message.attachment)}}</div>
              </div>
              <button mat-icon-button class="download-button" (click)="downloadFile(message.attachment)" matTooltip="Download">
                <mat-icon>download</mat-icon>
              </button>
            </div>

            <!-- Other Files -->
            <div *ngIf="message.attachment.file_type !== 'image' && message.attachment.file_type !== 'audio' && message.attachment.file_type !== 'voice'" class="attachment-card" (click)="downloadFile(message.attachment)">
              <div class="attachment-icon-wrapper">
                <mat-icon class="attachment-icon">{{getFileIcon(message.attachment.file_type)}}</mat-icon>
              </div>
              <div class="attachment-info">
                <div class="attachment-name">
                  {{message.attachment.file_name}}
                </div>
                <div class="attachment-meta">
                  <span class="attachment-type">{{message.attachment.file_type.toUpperCase()}}</span>
                  <span class="attachment-size">{{formatFileSize(message.attachment.file_size)}}</span>
                </div>
              </div>
              <mat-icon class="download-icon">download</mat-icon>
            </div>
          </div>

          <!-- WhatsApp Message Type Indicator -->
          <div class="message-type-indicator" *ngIf="message.message_type?.startsWith('whatsapp_')">
            <mat-icon class="type-icon">{{getMessageTypeIcon(message.message_type || '')}}</mat-icon>
            <span class="type-label">{{message.message_type?.replace('whatsapp_', '') || ''}}</span>
          </div>

          <!-- Message Meta NUR für non-system Messages -->
          <div class="message-meta" *ngIf="message.from !== 'system'">
            <!-- Badge für Bot/Agent -->
            <div class="message-badge" *ngIf="message.isBot || message.isAgent">
              {{message.isBot ? 'Bot' : getAgentNameForMessage(message)}}
            </div>

            <div class="message-time">
              {{message.timestamp | date:'HH:mm'}}
              <mat-icon *ngIf="!message.read && message.isAgent" class="unread-icon">done</mat-icon>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Nachrichten-Eingabe -->
    <div class="message-input">
      <!-- Chat Assignment Info für unzugewiesene Chats -->
      <div *ngIf="selectedChat?.status === 'human' && !selectedChat?.assigned_to"
           class="assignment-required-info">
        <div class="info-content">
          <mat-icon>assignment_ind</mat-icon>
          <span>Dieser Chat wartet auf Übernahme</span>

        </div>
      </div>

      <!-- Input disabled für zugewiesene Chats -->
      <div *ngIf="selectedChat?.assigned_to && selectedChat?.assigned_to !== currentAgent.id"
           class="input-disabled-info">
        <div class="info-content">
          <mat-icon>lock</mat-icon>
          <span>Nur {{ selectedChat.assigned_agent }} kann in diesem Chat schreiben</span>


        </div>
      </div>

      <!-- Chat ist Bot-Status -->
      <div *ngIf="selectedChat?.status === 'bot'"
           class="bot-status-info">
        <div class="info-content">
          <mat-icon>smart_toy</mat-icon>
          <span>Dieser Chat läuft aktuell über den Bot</span>

          <!-- Escalation Prompt Button -->
          <button *ngIf="canSendEscalationPrompt(selectedChat)"
                  mat-raised-button
                  color="accent"
                  (click)="sendEscalationPrompt(selectedChat)"
                  class="escalation-btn">
            <mat-icon>help_outline</mat-icon>
            Nachfragen
          </button>

          <!-- Cooldown Counter -->
          <div *ngIf="!canSendEscalationPrompt(selectedChat) && selectedChat.status === 'bot' && getEscalationCooldownText(selectedChat)"
               class="escalation-cooldown">
            <mat-icon>schedule</mat-icon>
            <span>Bis zur nächsten Anfrage: {{ getEscalationCooldownText(selectedChat) }}</span>
          </div>
        </div>
      </div>

      <!-- Status Indicator für geschlossene Chats -->
      <div *ngIf="selectedChat?.status === 'closed'"
           class="closed-chat-info">
        <div class="info-content">
          <mat-icon>block</mat-icon>
          <span>Dieser Chat wurde beendet</span>
        </div>
      </div>

      <!-- Input Container -->
      <div class="input-container" *ngIf="canWrite(selectedChat)">
        <!-- ✅ Unified File Input for all chat types (Website & WhatsApp) -->
        <input
          type="file"
          #fileInput
          (change)="isWhatsAppChat(selectedChat) ? onWhatsAppFileSelected($event) : onFileSelected($event)"
          style="display: none"
          [accept]="isWhatsAppChat(selectedChat) ? 'image/jpeg,image/png,image/gif,.pdf,.doc,.docx,.xls,.xlsx,.txt,video/mp4,video/quicktime' : '*/*'"
        />

        <!-- File Attachment Button - Universal for all chats -->
        <div class="attachment-buttons">
          <button
            mat-icon-button
            class="attach-button"
            (click)="fileInput.click()"
            [matTooltip]="isWhatsAppChat(selectedChat) ? 'Datei anhängen (Bilder, Dokumente, Videos)' : 'Datei anhängen'">
            <mat-icon>attach_file</mat-icon>
          </button>
        </div>

        <div class="textarea-wrapper">
          <textarea
            placeholder="Nachricht schreiben..."
            #messageInput
            rows="2"
            [maxLength]="1000"
            (keydown)="onKeyDown($event, messageInput)"></textarea>
          <div class="char-counter">
            {{ messageInput.value?.length || 0 }}/1000
          </div>
        </div>

        <button
          mat-fab
          color="primary"
          class="send-button"
          (click)="isWhatsAppChat(selectedChat) ? sendWhatsAppMessage(messageInput.value, messageInput) : sendMessage(messageInput.value, messageInput)"
          [disabled]="!messageInput.value?.trim()"
          [matTooltip]="isWhatsAppChat(selectedChat) ? 'WhatsApp Nachricht senden' : 'Nachricht senden'">
          <mat-icon>send</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Transfer Dialog -->
  <div class="dialog-overlay" *ngIf="showTransferDialog()">
    <div class="dialog-container">
      <div class="dialog-header">
        <h3>Chat übertragen</h3>
        <button mat-icon-button (click)="closeTransferDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="dialog-content">
        <p>Chat von <strong>{{ selectedChatForTransfer?.customerName }}</strong> übertragen an:</p>

        <form [formGroup]="transferForm">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Agent auswählen</mat-label>
            <mat-select formControlName="selectedAgent">
              <mat-option *ngFor="let agent of availableAgents" [value]="agent.id">
                {{ agent.name }} ({{ agent.current_chats }} aktive Chats)
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Grund (optional)</mat-label>
            <textarea matInput
                      formControlName="transferReason"
                      placeholder="Warum wird der Chat übertragen?"
                      rows="3"></textarea>
          </mat-form-field>
        </form>
      </div>

      <div class="dialog-actions">
        <button mat-button (click)="closeTransferDialog()">Abbrechen</button>
        <button mat-raised-button
                color="primary"
                [disabled]="!transferForm.get('selectedAgent')?.value"
                (click)="transferChat(transferForm.get('selectedAgent')?.value)">
          Übertragen
        </button>
      </div>
    </div>
  </div>

  <!-- Close Chat Dialog -->
  <div class="dialog-overlay" *ngIf="showCloseChatDialog()">
    <div class="dialog-container">
      <div class="dialog-header">
        <h3>Chat beenden</h3>
        <button mat-icon-button (click)="closeCloseChatDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="dialog-content">
        <p>Möchten Sie den Chat mit <strong>{{ chatToClose?.customerName || 'diesem Benutzer' }}</strong> beenden?</p>

        <form [formGroup]="closeDialogForm">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Grund (optional)</mat-label>
            <textarea
              matInput
              formControlName="closeChatReason"
            placeholder="Warum wird der Chat beendet?"
            rows="3"
            maxlength="255">
            </textarea>
          </mat-form-field>
        </form>

        <div class="warning-note">
          <mat-icon color="warn">warning</mat-icon>
          <span>Der Benutzer wird benachrichtigt, dass der Chat beendet wurde.</span>
        </div>
      </div>

      <div class="dialog-actions">
        <button mat-button (click)="closeCloseChatDialog()">Abbrechen</button>
        <button mat-raised-button
                color="warn"
                (click)="closeChatByAgent()">
          <mat-icon>close</mat-icon>
          Chat beenden
        </button>
      </div>
    </div>
  </div>

  <!-- ✅ NOTIFICATION PERMISSION DIALOG -->
  <div class="dialog-overlay permission-dialog-overlay" *ngIf="showPermissionDialog()">
    <div class="dialog-container permission-dialog">
      <div class="dialog-header">
        <div class="permission-icon">
          <mat-icon class="notification-icon">notifications_active</mat-icon>
        </div>
        <h3>Benachrichtigungen aktivieren?</h3>
      </div>

      <div class="dialog-content permission-content">
        <p class="permission-description">
          <strong>Bleiben Sie immer informiert!</strong><br>
          Erhalten Sie sofort eine Benachrichtigung, wenn:
        </p>

        <ul class="permission-features">
          <li>
            <mat-icon class="feature-icon">message</mat-icon>
            <span>Eine neue Nachricht von einem Besucher eingeht</span>
          </li>
          <li>
            <mat-icon class="feature-icon">swap_horiz</mat-icon>
            <span>Ein Chat an Sie übertragen wird</span>
          </li>
          <li>
            <mat-icon class="feature-icon">person_add</mat-icon>
            <span>Ein neuer Besucher Hilfe anfordert</span>
          </li>
        </ul>

        <div class="permission-note">
          <mat-icon class="info-icon">info</mat-icon>
          <span>Benachrichtigungen erscheinen nur, wenn Sie das Dashboard nicht aktiv nutzen.</span>
        </div>
      </div>

      <div class="dialog-actions permission-actions">
        <button mat-button
                class="decline-button"
                (click)="declineNotificationPermission()">
          <mat-icon>block</mat-icon>
          Nicht erlauben
        </button>
        <button mat-raised-button
                color="primary"
                class="accept-button"
                (click)="acceptNotificationPermission()">
          <mat-icon>check</mat-icon>
          Erlauben
        </button>
      </div>
    </div>
  </div>

  <!-- Leerer Chat-Zustand -->
  <ng-template #noChatSelected>
    <div class="empty-chat">
      <div class="empty-content">
        <div class="empty-icon">
          <mat-icon>chat_bubble_outline</mat-icon>
        </div>
        <h3>Wählen Sie einen Chat aus</h3>
        <p>Wählen Sie eine Konversation aus der Liste oder warten Sie auf neue Nachrichten</p>
      </div>
    </div>
  </ng-template>

  <!-- Staff Management Overlay -->
  <div class="staff-management-overlay" *ngIf="showStaffManagement" (click)="closeStaffManagement()">
    <div class="staff-management-content" (click)="$event.stopPropagation()">
      <div class="staff-management-header">
        <h2>Mitarbeiter-Verwaltung</h2>
        <button mat-icon-button (click)="closeStaffManagement()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <app-staff-management></app-staff-management>
    </div>
  </div>

  <!-- Offer Management Overlay -->
  <div class="staff-management-overlay" *ngIf="showOfferManagement" (click)="closeOfferManagement()">
    <div class="staff-management-content" (click)="$event.stopPropagation()">
      <div class="staff-management-header">
        <h2>Angebote-Verwaltung</h2>
        <button mat-icon-button (click)="closeOfferManagement()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <app-offer-management></app-offer-management>
    </div>
  </div>
</div>
