<div class="appointment-booking-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="container">
      <button mat-icon-button class="back-button" (click)="goBack()" matTooltip="Zurück zur Startseite">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h1 class="page-title">Termin buchen</h1>
      <p class="page-subtitle">Buchen Sie Ihren persönlichen Beratungstermin bei YISU Travel</p>
    </div>
  </div>

  <!-- Page Content -->
  <div class="page-content">
    <div class="container">
      <mat-vertical-stepper #stepper class="appointment-stepper">
        
        <!-- Step 1: Personal Data -->
        <mat-step [stepControl]="personalDataForm" label="Persönliche Daten">
          <ng-template matStepLabel>
            <div class="step-label">
              <mat-icon>person</mat-icon>
              <span>Persönliche Daten</span>
            </div>
          </ng-template>
          
          <form [formGroup]="personalDataForm" class="step-form">
            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Name *</mat-label>
                <input matInput formControlName="customer_name" placeholder="Ihr vollständiger Name">
                <mat-error *ngIf="personalDataForm.get('customer_name')?.hasError('required')">
                  Name ist erforderlich
                </mat-error>
                <mat-error *ngIf="personalDataForm.get('customer_name')?.hasError('minlength')">
                  Name muss mindestens 2 Zeichen lang sein
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>E-Mail *</mat-label>
                <input matInput formControlName="customer_email" type="email" placeholder="ihre.email@beispiel.de">
                <mat-error *ngIf="personalDataForm.get('customer_email')?.hasError('required')">
                  E-Mail ist erforderlich
                </mat-error>
                <mat-error *ngIf="personalDataForm.get('customer_email')?.hasError('email')">
                  Bitte geben Sie eine gültige E-Mail-Adresse ein
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Telefon *</mat-label>
                <input matInput formControlName="customer_phone" placeholder="+49 123 456789">
                <mat-error *ngIf="personalDataForm.get('customer_phone')?.hasError('required')">
                  Telefonnummer ist erforderlich
                </mat-error>
                <mat-error *ngIf="personalDataForm.get('customer_phone')?.hasError('pattern')">
                  Bitte geben Sie eine gültige Telefonnummer ein
                </mat-error>
              </mat-form-field>
            </div>

            <div class="step-actions">
              <button mat-raised-button color="primary" matStepperNext [disabled]="!personalDataForm.valid">
                Weiter
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          </form>
        </mat-step>

        <!-- Step 2: Date & Time Selection -->
        <mat-step [stepControl]="appointmentForm" label="Terminauswahl">
          <ng-template matStepLabel>
            <div class="step-label">
              <mat-icon>event</mat-icon>
              <span>Terminauswahl</span>
            </div>
          </ng-template>
          
          <form [formGroup]="appointmentForm" class="step-form">
            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Datum auswählen *</mat-label>
                <input matInput 
                       [matDatepicker]="picker"
                       [min]="minDate"
                       formControlName="appointment_date"
                       (dateChange)="onDatePickerChange($event.value)"
                       (click)="picker.open()"
                       placeholder="DD.MM.YYYY"
                       readonly>
                <mat-datepicker-toggle matSuffix [for]="picker">
                  <mat-icon matDatepickerToggleIcon>calendar_today</mat-icon>
                </mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
                <mat-error *ngIf="appointmentForm.get('appointment_date')?.hasError('required')">
                  Datum ist erforderlich
                </mat-error>
              </mat-form-field>
            </div>


            <!-- Available Time Slots -->
            <div *ngIf="selectedDate" class="time-slots-section">
              <h4>Verfügbare Uhrzeiten für {{getFormattedDate(selectedDate)}}</h4>
              
              <div *ngIf="isLoadingSlots" class="loading-slots">
                <mat-spinner diameter="30"></mat-spinner>
                <span>Lade verfügbare Zeiten...</span>
              </div>

              <div *ngIf="!isLoadingSlots && availableSlots.length === 0" class="no-slots">
                <mat-icon>info</mat-icon>
                <span>Für dieses Datum sind keine Termine verfügbar.</span>
              </div>

              <div *ngIf="!isLoadingSlots && availableSlots.length > 0" class="time-slots-container">

                <!-- Time Slot Selection - Only One Selectable -->
                <div class="time-slots-grid">
                  <button mat-raised-button
                          *ngFor="let slot of availableSlots"
                          type="button"
                          [class.selected-time]="selectedTime === slot"
                          (click)="selectTimeSlot(slot)"
                          class="time-slot-button">
                    {{slot}} Uhr
                  </button>
                </div>

                <!-- Selected Time Display -->
                <div *ngIf="selectedTime" class="selected-time-display">
                  <mat-icon>check_circle</mat-icon>
                  <span><strong>Ausgewählte Zeit:</strong> {{selectedTime}} Uhr</span>
                </div>

                <!-- Custom Time Input -->
                <div class="custom-time-section">
                  <mat-form-field appearance="outline" class="custom-time-field">
                    <mat-label>Oder eigene Uhrzeit eingeben</mat-label>
                    <input matInput 
                           type="time"
                           [value]="customTime"
                           (change)="onCustomTimeChange($event)"
                           placeholder="HH:MM">
                    <mat-hint>Format: HH:MM (z.B. 14:30)</mat-hint>
                  </mat-form-field>
                  <button mat-stroked-button 
                          (click)="addCustomTime()"
                          [disabled]="!customTime || !isCustomTimeValid()"
                          class="add-custom-time-btn">
                    <mat-icon>add</mat-icon>
                    Hinzufügen
                  </button>
                </div>
              </div>

              <!-- Business Hours Info -->
              <div class="business-hours-info">
                <mat-icon>schedule</mat-icon>
                <div class="business-hours-text">
                  <div><strong>Öffnungszeiten:</strong></div>
                  <div>Montag - Freitag: 10:00 - 18:00 Uhr</div>
                  <div>Samstag: 10:30 - 15:30 Uhr</div>
                </div>
              </div>
            </div>

            <div class="step-actions">
              <button mat-button matStepperPrevious>
                <mat-icon>arrow_back</mat-icon>
                Zurück
              </button>
              <button mat-raised-button color="primary" matStepperNext [disabled]="!isAppointmentValid()">
                Weiter
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          </form>
        </mat-step>

        <!-- Step 3: Travel Details -->
        <mat-step [stepControl]="travelDetailsForm" label="Reisedetails">
          <ng-template matStepLabel>
            <div class="step-label">
              <mat-icon>flight_takeoff</mat-icon>
              <span>Reisedetails</span>
            </div>
          </ng-template>
          
          <form [formGroup]="travelDetailsForm" class="step-form">
            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Art der Beratung *</mat-label>
                <mat-select formControlName="service_type">
                  <mat-option *ngFor="let service of serviceTypes" [value]="service.value">
                    {{service.label}}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="travelDetailsForm.get('service_type')?.hasError('required')">
                  Art der Beratung ist erforderlich
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Anzahl Reisende *</mat-label>
                <input matInput 
                       type="number" 
                       formControlName="travelers_count" 
                       min="1" 
                       max="20"
                       placeholder="1">
                <mat-error *ngIf="travelDetailsForm.get('travelers_count')?.hasError('required')">
                  Anzahl Reisende ist erforderlich
                </mat-error>
                <mat-error *ngIf="travelDetailsForm.get('travelers_count')?.hasError('min')">
                  Mindestens 1 Person erforderlich
                </mat-error>
                <mat-error *ngIf="travelDetailsForm.get('travelers_count')?.hasError('max')">
                  Maximal 20 Personen möglich
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Reiseziel (optional)</mat-label>
                <input matInput formControlName="destination" placeholder="z.B. Mallorca, Thailand, USA...">
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Budget (optional)</mat-label>
                <mat-select formControlName="budget_range">
                  <mat-option *ngFor="let budget of budgetRanges" [value]="budget.value">
                    {{budget.label}}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>

            <div class="step-actions">
              <button mat-button matStepperPrevious>
                <mat-icon>arrow_back</mat-icon>
                Zurück
              </button>
              <button mat-raised-button color="primary" matStepperNext [disabled]="!isTravelDetailsValid()">
                Weiter
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          </form>
        </mat-step>

        <!-- Step 4: Message -->
        <mat-step [stepControl]="messageForm" label="Nachricht">
          <ng-template matStepLabel>
            <div class="step-label">
              <mat-icon>message</mat-icon>
              <span>Nachricht</span>
            </div>
          </ng-template>
          
          <form [formGroup]="messageForm" class="step-form">
            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Nachricht (optional)</mat-label>
                <textarea matInput 
                          formControlName="message" 
                          rows="4" 
                          placeholder="Teilen Sie uns mit, was Sie sich von der Beratung erhoffen oder welche speziellen Wünsche Sie haben..."></textarea>
                <mat-hint align="end">{{messageForm.get('message')?.value?.length || 0}}/1000</mat-hint>
              </mat-form-field>
            </div>

            <div class="step-actions">
              <button mat-button matStepperPrevious>
                <mat-icon>arrow_back</mat-icon>
                Zurück
              </button>
              <button mat-raised-button color="primary" matStepperNext [disabled]="!isMessageValid()">
                Weiter
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          </form>
        </mat-step>

        <!-- Step 5: Confirmation -->
        <mat-step label="Bestätigung">
          <ng-template matStepLabel>
            <div class="step-label">
              <mat-icon>check_circle</mat-icon>
              <span>Bestätigung</span>
            </div>
          </ng-template>
          
          <div class="confirmation-step">
            <h3>Bitte überprüfen Sie Ihre Angaben:</h3>
            
            <div class="confirmation-details">
              <div class="detail-section">
                <h4>Persönliche Daten</h4>
                <div class="detail-row">
                  <span><strong>Name:</strong> {{personalDataForm.get('customer_name')?.value}}</span>
                </div>
                <div class="detail-row">
                  <span><strong>E-Mail:</strong> {{personalDataForm.get('customer_email')?.value}}</span>
                </div>
                <div class="detail-row">
                  <span><strong>Telefon:</strong> {{personalDataForm.get('customer_phone')?.value}}</span>
                </div>
              </div>

              <div class="detail-section">
                <h4>Termin</h4>
                <div class="detail-row">
                  <span><strong>Datum:</strong> {{selectedDate ? getDisplayDateFormat(selectedDate) : ''}}</span>
                </div>
                <div class="detail-row">
                  <span><strong>Uhrzeit:</strong> {{getSelectedTimesDisplay()}}</span>
                </div>
              </div>

              <div class="detail-section">
                <h4>Reisedetails</h4>
                <div class="detail-row">
                  <span><strong>Art der Beratung:</strong> {{getServiceTypeLabel(travelDetailsForm.get('service_type')?.value)}}</span>
                </div>
                <div class="detail-row">
                  <span><strong>Anzahl Reisende:</strong> {{travelDetailsForm.get('travelers_count')?.value}} Person(en)</span>
                </div>
                <div class="detail-row" *ngIf="travelDetailsForm.get('destination')?.value">
                  <span><strong>Reiseziel:</strong> {{travelDetailsForm.get('destination')?.value}}</span>
                </div>
                <div class="detail-row" *ngIf="travelDetailsForm.get('budget_range')?.value">
                  <span><strong>Budget:</strong> {{getBudgetRangeLabel(travelDetailsForm.get('budget_range')?.value)}}</span>
                </div>
                <div class="detail-row" *ngIf="messageForm.get('message')?.value">
                  <div class="message-display">
                    <strong>Nachricht:</strong>
                    <div class="message-content">
                      {{messageForm.get('message')?.value}}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="step-actions">
              <button mat-button matStepperPrevious>
                <mat-icon>arrow_back</mat-icon>
                Zurück
              </button>
              <button mat-raised-button 
                      color="primary" 
                      (click)="submitAppointment()"
                      [disabled]="isSubmitting">
                <mat-spinner *ngIf="isSubmitting" diameter="20" class="button-spinner"></mat-spinner>
                <mat-icon *ngIf="!isSubmitting">check</mat-icon>
                {{isSubmitting ? 'Wird gebucht...' : 'Termin buchen'}}
              </button>
            </div>
          </div>
        </mat-step>
      </mat-vertical-stepper>
    </div>
  </div>
</div>